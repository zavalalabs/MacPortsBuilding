name: Build MacPorts Binaries - arm64

on:
  workflow_dispatch:
  push:
    paths:
      - "macports.txt"
      - "scripts/**"
      - ".github/workflows/build-macports-arm64.yml"

jobs:
  build-arm64:
    strategy:
      fail-fast: false
      matrix:
        # These must be labels on your self-hosted runners
        os_label: [macos-14, macos-15]

    runs-on:
      - self-hosted
      - macOS
      - ARM64
      - ${{ matrix.os_label }}

    steps:
      - name: Sanity (print runner info)
        run: |
          echo "Wanted labels: self-hosted macOS ARM64 ${{ matrix.os_label }}"
          echo "runner.os=${{ runner.os }}"
          echo "runner.arch=${{ runner.arch }}"
          uname -a
          sw_vers
          arch
          sysctl -n hw.ncpu

      # Hard guard: fail if the wrong platform picks this up
      - name: Assert correct OS/arch
        if: ${{ runner.os != 'macOS' || runner.arch != 'ARM64' }}
        run: |
          echo "::error::This workflow must run on macOS ARM64. Got ${RUNNER_OS}/${RUNNER_ARCH}."
          exit 1

      - uses: actions/checkout@v4

      - name: Make scripts executable (defensive)
        run: |
          chmod +x scripts/bootstrap_macports.sh
          chmod +x scripts/build_archives.sh
          chmod +x scripts/build_pkgs.sh || true

      - name: Bootstrap MacPorts (arm64)
        run: bash scripts/bootstrap_macports.sh

      - name: Build binary archives
        run: bash scripts/build_archives.sh macports.txt

      - name: Upload archives
        uses: actions/upload-artifact@v4
        with:
          name: macports-archives-${{ matrix.os_label }}-arm64
          path: artifacts/archives
