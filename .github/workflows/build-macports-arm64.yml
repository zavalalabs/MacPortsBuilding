name: Build MacPorts Binaries - arm64

on:
  workflow_dispatch:
  push:
    paths:
      - "macports.txt"
      - "scripts/**"
      - ".github/workflows/build-macports-arm64.yml"

jobs:
  build-arm64:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Sanity (print runner info)
        run: |
          echo "Runner: ${{ matrix.os }}"
          uname -a
          sw_vers
          arch
          sysctl -n hw.ncpu

      - name: Make scripts executable (defensive)
        run: |
          chmod +x scripts/bootstrap_macports.sh
          chmod +x scripts/build_archives.sh
          chmod +x scripts/build_pkgs.sh || true

      - name: Bootstrap MacPorts (arm64)
        run: bash scripts/bootstrap_macports.sh

      - name: Build binary archives
        run: bash scripts/build_archives.sh macports.txt

      - name: Upload archives
        uses: actions/upload-artifact@v4
        with:
          name: macports-archives-${{ matrix.os }}-arm64
          path: artifacts/archives
