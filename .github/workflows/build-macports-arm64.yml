name: Build MacPorts Binaries (arm64)

on:
  workflow_dispatch:
  push:
    paths:
      - "macports.txt"
      - "scripts/**"
      - ".github/workflows/build-macports-arm64.yml"

jobs:
  build-arm64:
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Sanity (print runner info)
        run: |
          uname -a
          sw_vers
          arch
          sysctl -n hw.ncpu

      - name: Make scripts executable (defensive)
        run: |
          chmod +x scripts/bootstrap_macports.sh
          chmod +x scripts/build_archives.sh
          chmod +x scripts/build_pkgs.sh || true

      - name: Bootstrap MacPorts (arm64)
        env:
          # Optionally pin a different MacPorts pkg:
           MACPORTS_PKG_URL: https://github.com/macports/macports-base/releases/download/v2.10.7/MacPorts-2.10.7-15-Sequoia.pkg
        run: bash scripts/bootstrap_macports.sh

      - name: Build binary archives
        run: bash scripts/build_archives.sh macports.txt

      - name: Upload archives
        uses: actions/upload-artifact@v4
        with:
          name: macports-archives-macos-15-arm64
          path: artifacts/archives

      # Enable if you also want installable pkgs/mpkgs
      - name: (Optional) Build installer pkgs
        if: ${{ false }}
        run: bash scripts/build_pkgs.sh macports.txt

      - name: (Optional) Upload pkgs
        if: ${{ false }}
        uses: actions/upload-artifact@v4
        with:
          name: macports-pkgs-macos-15-arm64
          path: artifacts/pkgs
