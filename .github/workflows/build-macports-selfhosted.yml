name: Build MacPorts Self-Hosted
on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 480  # 8 hours timeout
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up environment
        run: |
          echo "Setting up build environment..."
          export PATH=/opt/local/bin:/opt/local/sbin:$PATH
          
      - name: Fix initial permissions
        run: |
          sudo chown -R macports:admin /opt/local || true
          sudo find /opt/local -type d -exec chmod 755 {} + 2>/dev/null || true
          sudo chmod -R 755 /opt/local/var/macports || true
          
      - name: Clean MacPorts
        run: |
          sudo port clean --all all || true
          sudo port uninstall inactive || true
          
      - name: Bootstrap MacPorts
        run: |
          chmod +x scripts/bootstrap_macports.sh
          ./scripts/bootstrap_macports.sh
          
      - name: Build archives
        run: |
          chmod +x scripts/build_archives.sh
          ./scripts/build_archives.sh
        continue-on-error: true
        
      - name: Build packages
        run: |
          chmod +x scripts/build_pkgs.sh
          ./scripts/build_pkgs.sh
        continue-on-error: true
        
      - name: Final cleanup and permissions
        run: |
          sudo find /opt/local -type d -exec chmod 755 {} + 2>/dev/null || true
          sudo chown -R macports:admin /opt/local 2>/dev/null || true
        if: always()
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macports-build-logs
          path: |
            failed_ports.log
            *.log
        if: always()